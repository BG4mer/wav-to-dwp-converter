<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WAV → DWP — Pro (Mobile UI)</title>
  <meta name="description" content="Mobile-first WAV → DWP converter with modern FL Studio Mobile–style UI, draggable/resizable zones, waveform preview, and mobile-safe downloads." />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root{
      --bg:#0e0e10; --panel:#141416; --accent1:#ff7a1a; --accent2:#ffb07a; --muted:#9aa0a6; --glass:rgba(255,255,255,0.03);
      --radius:14px; --pad:14px; --shadow:0 8px 30px rgba(0,0,0,0.6);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#070707);font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:#f7f7f7}
    header{background:linear-gradient(90deg,var(--accent1),#ff9a3a);padding:18px 16px;display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:rgba(0,0,0,0.12);display:flex;align-items:center;justify-content:center;font-weight:800}
    .title{font-size:18px;font-weight:700}
    .subtitle{color:var(--muted);font-size:13px}

    .container{max-width:1100px;margin:18px auto;padding:var(--pad);display:grid;grid-template-columns:360px 1fr;gap:18px}
    @media (max-width:980px){.container{grid-template-columns:1fr;padding:12px}}

    .panel{background:var(--panel);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
    .panel h3{margin:6px 0 8px 0}
    label{display:block;color:var(--muted);font-size:13px;margin-top:10px}
    input[type=file], input[type=number], select{width:100%;padding:10px;border-radius:10px;border:none;background:#0f0f11;color:#fff}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#121212;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:600}

    /* Tabs */
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{flex:1;padding:10px;border-radius:10px;background:transparent;text-align:center;color:var(--muted);cursor:pointer}
    .tab.active{background:linear-gradient(90deg,rgba(255,122,26,0.14),rgba(255,176,122,0.06));color:var(--accent2);font-weight:700}

    /* Waveform + editor */
    #waveWrap{background:#0b0b0c;border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:10px}
    #waveform{height:140px;border-radius:8px;overflow:hidden}
    .controls{display:flex;gap:8px;flex-wrap:wrap}

    /* zone editor */
    #zoneArea{position:relative;height:220px;background:#0b0b0b;border-radius:10px;border:1px solid rgba(255,255,255,0.03);overflow:hidden}
    .zone{position:absolute;background:linear-gradient(180deg,rgba(255,122,26,0.95),rgba(255,176,122,0.9));border-radius:8px;border:2px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;color:#121212;font-weight:700;touch-action:none}
    .zone .handle{position:absolute;right:6px;bottom:4px;width:16px;height:16px;border-radius:4px;background:rgba(0,0,0,0.15);}

    /* status */
    #status{margin-top:6px;padding:10px;border-radius:10px;background:linear-gradient(180deg,#0b0b0b,#080808);border:1px solid rgba(255,255,255,0.03);font-size:14px;color:var(--muted)}

    footer{max-width:1100px;margin:18px auto;padding:8px 16px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <header>
    <div class="logo">FL</div>
    <div>
      <div class="title">WAV → DWP Converter Pro</div>
      <div class="subtitle">Mobile-first • FLM-styled • Drag & Drop zones</div>
    </div>
  </header>

  <main class="container">
    <!-- left column: tools -->
    <div class="panel">
      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="load">Load</div>
        <div class="tab" data-tab="settings">Settings</div>
        <div class="tab" data-tab="editor">Editor</div>
      </div>

      <div class="tabContent" id="load">
        <h3>Load WAV</h3>
        <input id="wavInput" type="file" accept="audio/wav" />
        <label>Preview</label>
        <div class="controls"><button id="playBtn" class="btn ghost">Play/Pause</button><button id="stopBtn" class="btn ghost">Stop</button><button id="clearBtn" class="btn ghost">Clear</button></div>
      </div>

      <div class="tabContent" id="settings" style="display:none">
        <h3>Chromatic Settings</h3>
        <label>Slice length (sec)</label>
        <input id="sliceLength" type="number" value="0.25" step="0.01">
        <label>Root MIDI note</label>
        <input id="rootNote" type="number" value="60">
        <label>Slices (auto)</label>
        <input id="slicesAuto" type="number" value="60">
        <div style="margin-top:10px"><button id="autoSplitBtn" class="btn">Auto-split (equal)</button></div>
      </div>

      <div class="tabContent" id="editor" style="display:none">
        <h3>Zone Editor</h3>
        <label>Add / remove zones</label>
        <div style="display:flex;gap:8px"><button id="addZone" class="btn">Add Zone</button><button id="resetZones" class="btn ghost">Reset Zones</button></div>
        <label style="margin-top:12px">Advanced</label>
        <div style="display:flex;gap:8px"><input id="crossfade" type="number" value="10" min="0" step="1"><input id="velocityLayers" type="number" value="1" min="1" step="1"></div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="exportBtn" class="btn">Export ZIP (DWP)</button>
        <button id="installBtn" class="btn">Install (Android)</button>
      </div>

      <div id="status">Ready — load a WAV to begin.</div>
    </div>

    <!-- right column: waveform + zone area -->
    <div>
      <div class="panel" id="waveWrap">
        <h3>Waveform</h3>
        <div id="waveform">Loading waveform…</div>
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="controls"><button id="markerAdd" class="btn ghost">Add Marker</button><button id="markersClear" class="btn ghost">Clear Markers</button></div>
          <div style="color:var(--muted);font-size:13px">Markers: <span id="markerCount">0</span></div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <h3>Zone Mapping</h3>
        <div id="zoneArea" aria-label="zone-editor"></div>
        <div style="margin-top:10px;color:var(--muted);font-size:13px">Drag and resize zones. Tap zone to preview assigned slice when exported.</div>
      </div>
    </div>
  </main>

  <footer>Built for mobile — tap Export then open the ZIP in FL Studio Mobile &gt; DirectWave &gt; User</footer>

  <!-- Wavesurfer for waveform preview -->
  <script src="https://unpkg.com/wavesurfer.js"></script>
  <script>
  // App state
  const state = {audioFile:null, wavesurfer:null, markers:[], zones:[], slices:[]};

  // Tabs
  document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const tabName = t.dataset.tab;
    document.querySelectorAll('.tabContent').forEach(c=>c.style.display='none');
    document.getElementById(tabName).style.display='block';
  }));

  // init wavesurfer
  function initWave(){
    if(state.wavesurfer) state.wavesurfer.destroy();
    state.wavesurfer = WaveSurfer.create({container:'#waveform', waveColor:'#222', progressColor:'#ff7a1a', height:140});
    state.wavesurfer.on('ready', ()=>{ updateStatus('WAV loaded — duration: '+state.wavesurfer.getDuration().toFixed(2)+'s'); });
    state.wavesurfer.on('finish', ()=>{ /* loop */ });
  }
  initWave();

  // load file
  const wavInput = document.getElementById('wavInput');
  wavInput.addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return; state.audioFile = f; initWave(); state.wavesurfer.load(URL.createObjectURL(f)); state.markers.length=0; document.getElementById('markerCount').innerText='0'; clearZones();
  });

  // play controls
  document.getElementById('playBtn').addEventListener('click', ()=>{ if(state.wavesurfer) state.wavesurfer.playPause(); });
  document.getElementById('stopBtn').addEventListener('click', ()=>{ if(state.wavesurfer) state.wavesurfer.stop(); });
  document.getElementById('clearBtn').addEventListener('click', ()=>{ state.audioFile=null; state.wavesurfer.empty(); updateStatus('Cleared'); });

  // markers
  document.getElementById('markerAdd').addEventListener('click', ()=>{ if(!state.wavesurfer) return; const t=state.wavesurfer.getCurrentTime(); state.markers.push(t); state.markers.sort((a,b)=>a-b); document.getElementById('markerCount').innerText=state.markers.length; updateStatus('Marker added at '+t.toFixed(2)+'s'); });
  document.getElementById('markersClear').addEventListener('click', ()=>{ state.markers.length=0; document.getElementById('markerCount').innerText='0'; updateStatus('Markers cleared'); });

  // Auto split
  document.getElementById('autoSplitBtn').addEventListener('click', async ()=>{
    if(!state.audioFile){ updateStatus('Load WAV first'); return; }
    const parts = Math.max(1, Number(document.getElementById('slicesAuto').value)||60);
    updateStatus('Auto-splitting into '+parts+' slices...');
    state.slices = await splitEqualParts(state.audioFile, parts);
    updateStatus('Auto-split complete — '+state.slices.length+' slices ready');
  });

  // zone management
  const zoneArea = document.getElementById('zoneArea');
  function createZone(x=10,y=10,w=80,h=48){
    const el = document.createElement('div'); el.className='zone'; el.style.left=x+'px'; el.style.top=y+'px'; el.style.width=w+'px'; el.style.height=h+'px';
    const handle = document.createElement('div'); handle.className='handle'; el.appendChild(handle);
    zoneArea.appendChild(el);
    makeDraggable(el, handle);
    state.zones.push({el,left:x,top:y,width:w,height:h});
    return el;
  }
  document.getElementById('addZone').addEventListener('click', ()=>{ createZone(20+state.zones.length*12,20,90,48); });
  document.getElementById('resetZones').addEventListener('click', ()=>{ clearZones(); updateStatus('Zones reset'); });
  function clearZones(){ state.zones.forEach(z=>z.el.remove()); state.zones=[]; }

  // make draggable + resizable
  function makeDraggable(el, handle){
    let startX, startY, startL, startT, dragging=false, resizing=false;
    handle.addEventListener('pointerdown', (e)=>{ e.preventDefault(); resizing=true; startX=e.clientX; startY=e.clientY; startL=parseInt(el.style.width); startT=parseInt(el.style.height); el.setPointerCapture(e.pointerId); });
    el.addEventListener('pointerdown', (e)=>{ if(e.target===handle) return; dragging=true; startX=e.clientX; startY=e.clientY; startL=parseInt(el.style.left); startT=parseInt(el.style.top); el.setPointerCapture(e.pointerId); });
    el.addEventListener('pointermove', (e)=>{ if(!dragging && !resizing) return; e.preventDefault(); if(dragging){ let nx = startL + (e.clientX - startX); let ny = startT + (e.clientY - startY); nx = Math.max(0, Math.min(zoneArea.clientWidth - el.offsetWidth, nx)); ny = Math.max(0, Math.min(zoneArea.clientHeight - el.offsetHeight, ny)); el.style.left = nx + 'px'; el.style.top = ny + 'px'; } else if(resizing){ let nw = Math.max(32, startL + (e.clientX - startX)); let nh = Math.max(20, startT + (e.clientY - startY)); nw = Math.min(zoneArea.clientWidth - el.offsetLeft, nw); nh = Math.min(zoneArea.clientHeight - el.offsetTop, nh); el.style.width = nw + 'px'; el.style.height = nh + 'px'; } });
    el.addEventListener('pointerup', (e)=>{ dragging=false; resizing=false; try{ el.releasePointerCapture(e.pointerId); }catch(e){} });
  }

  // splitting utilities
  async function splitEqualParts(file, parts){
    const ab = await file.arrayBuffer();
    const audioCtx = new (window.OfflineAudioContext || window.AudioContext)(1,1,44100);
    const decoded = await audioCtx.decodeAudioData(ab.slice(0));
    const duration = decoded.duration; const partLen = duration / parts; const out=[];
    for(let i=0;i<parts;i++){ const s = i*partLen; const e = (i<parts-1)?(s+partLen):duration; const blob = audioBufferToWav(decoded, s, e); out.push({name:`sample_${i}.wav`, blob}); }
    return out;
  }

  function audioBufferToWav(buffer, startSec=0, endSec=null){
    const sampleRate = buffer.sampleRate; const ch = buffer.numberOfChannels; const startOffset = Math.floor(startSec*sampleRate); const endOffset = Math.floor((endSec===null?buffer.length:Math.min(buffer.length, Math.floor(endSec*sampleRate)))); const len = endOffset - startOffset; const tmp = new Float32Array(len*ch);
    for(let c=0;c<ch;c++){ const channel = buffer.getChannelData(c); for(let i=0;i<len;i++){ tmp[i*ch + c] = channel[startOffset + i]; } }
    const wavBuffer = new ArrayBuffer(44 + tmp.length*2); const view = new DataView(wavBuffer);
    let offset = 0; function writeStr(s){ for(let i=0;i<s.length;i++) view.setUint8(offset++, s.charCodeAt(i)); }
    writeStr('RIFF'); view.setUint32(offset,36 + tmp.length*2, true); offset+=4; writeStr('WAVE'); writeStr('fmt '); view.setUint32(offset,16,true); offset+=4; view.setUint16(offset,1,true); offset+=2; view.setUint16(offset,ch,true); offset+=2; view.setUint32(offset,sampleRate,true); offset+=4; view.setUint32(offset,sampleRate*ch*2,true); offset+=4; view.setUint16(offset,ch*2,true); offset+=2; view.setUint16(offset,16,true); offset+=2; writeStr('data'); view.setUint32(offset,tmp.length*2,true); offset+=4;
    for(let i=0;i<tmp.length;i++){ let s=Math.max(-1,Math.min(1,tmp[i])); view.setInt16(offset, s<0? s*0x8000 : s*0x7FFF, true); offset+=2; }
    return new Blob([view], {type:'audio/wav'});
  }

  // create dwp zip
  async function buildDwpZip(slices, root){ const zip = new JSZip(); const zonesXML = [];
    for(let i=0;i<slices.length;i++){ zip.file(slices[i].name, slices[i].blob); zonesXML.push(`<Zone><RootNote>${root + i}</RootNote><HiNote>${root + i}</HiNote><LoNote>${root + i}</LoNote><SampleName>${slices[i].name}</SampleName></Zone>`); }
    const xml = `<?xml version="1.0"?><DirectWavePresets><Program><Name>Converted Program</Name>${zonesXML.join('')}</Program></DirectWavePresets>`; zip.file('program.dwp', xml); return zip.generateAsync({type:'blob'}); }

  // export handler
  document.getElementById('exportBtn').addEventListener('click', async ()=>{
    try{
      if(state.slices && state.slices.length>0){ const dwp = await buildDwpZip(state.slices, Number(document.getElementById('rootNote').value || 60)); downloadBlob(dwp, 'Converted_DWP.zip'); updateStatus('Exported '+state.slices.length+' slices.'); return; }
      if(!state.audioFile){ updateStatus('Load a WAV first'); return; }
      // fallback: slice by sliceLength
      updateStatus('Slicing audio...'); const parts = Math.max(1, Math.floor((state.wavesurfer.getDuration() || 0) / Number(document.getElementById('sliceLength').value))); state.slices = await splitEqualParts(state.audioFile, parts); updateStatus('Packing '+state.slices.length+' slices...'); const dwp = await buildDwpZip(state.slices, Number(document.getElementById('rootNote').value || 60)); downloadBlob(dwp, 'Converted_DWP.zip'); updateStatus('Done — open ZIP in FL Studio Mobile > DirectWave > User');
    }catch(err){ console.error(err); updateStatus('Error: '+err.message); }
  });

  // install (Android) — attempt to write using File System Access API (best-effort)
  document.getElementById('installBtn').addEventListener('click', async ()=>{
    try{
      updateStatus('Preparing installer...'); const parts = state.slices && state.slices.length? state.slices.length : Math.max(1, Math.floor((state.wavesurfer.getDuration() || 0) / Number(document.getElementById('sliceLength').value))); if(!state.slices || !state.slices.length) state.slices = await splitEqualParts(state.audioFile, parts);
      const dwpZip = await buildDwpZip(state.slices, Number(document.getElementById('rootNote').value || 60));
      // Try File System Access API
      if(window.showSaveFilePicker){
        const handle = await window.showSaveFilePicker({suggestedName:'Converted_DWP.zip', types:[{description:'ZIP', accept:{'application/zip':['.zip']}}]});
        const writable = await handle.createWritable(); await writable.write(dwpZip); await writable.close(); updateStatus('Saved via File System API. Move to FLStudioMobile/DirectWave/User');
      } else {
        downloadBlob(dwpZip, 'Converted_DWP.zip'); updateStatus('Download started. Move file to FLStudioMobile/DirectWave/User');
      }
    }catch(e){ console.error(e); downloadBlob(dwpZip, 'Converted_DWP.zip'); updateStatus('Fallback download started.'); }
  });

  function updateStatus(msg){ document.getElementById('status').innerText = msg; }
  </script>
</body>
</html>
